# Podman Kube Play YAML for the Task App (LOCAL DEVELOPMENT ONLY)
#
# This file defines a SINGLE POD configuration for local testing with 'podman kube play'.
# All containers run in the same pod and share the network namespace (can communicate via localhost).
#
# For Google Kubernetes Engine (GKE) deployment, see the k8s-manifests/ directory.
# For Docker/Podman Compose deployment, see docker-compose.yml.
#
# === LOCAL DEVELOPMENT USAGE ===
#
# Before you can use this file, you need to build the container images for the services:
#
# podman build -t auth-api:latest -f auth-api/Dockerfile ./auth-api
# podman build -t tasks-api:latest -f tasks-api/Dockerfile ./tasks-api
# podman build -t frontend:latest -f frontend/Dockerfile ./frontend
#
# After building the images, you can deploy the application with:
#
# podman kube play podman-deployment.yml
#
# The application will be available at http://localhost:8080 
# (On Windows WSL, use: wsl ip addr show eth0 | findstr "inet " to find the WSL IP)
#
# To stop and remove the pod:
#
# podman kube down podman-deployment.yml
#
# === GKE DEPLOYMENT ===
#
# For production deployment to Google Kubernetes Engine, use the manifests in k8s-manifests/
# See k8s-manifests/README.md for deployment instructions.
#

---
# Persistent Volume Claim for PostgreSQL data
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi

---
# Single Pod containing all application containers
apiVersion: v1
kind: Pod
metadata:
  name: task-app-pod
  labels:
    app: task-app
spec:
  containers:
    # PostgreSQL Database
    - name: postgres
      image: postgres:15-alpine
      env:
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_PASSWORD
          value: "password"
        - name: POSTGRES_DB
          value: "tasksdb"
      ports:
        - containerPort: 5432
          hostPort: 5432
      volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data

    # Authentication API
    - name: auth-api
      image: auth-api:latest
      imagePullPolicy: Never
      env:
        - name: JWT_SECRET_KEY
          value: "un_secret_tres_fort_a_changer"
        - name: DB_USER
          value: "postgres"
        - name: DB_PASSWORD
          value: "password"
        - name: DB_HOST
          value: "localhost"  # Changed from 'db' to 'localhost' for single pod
        - name: DB_NAME
          value: "tasksdb"
      ports:
        - containerPort: 8000
          name: auth-api

    # Tasks API
    - name: tasks-api
      image: tasks-api:latest
      imagePullPolicy: Never
      command: ["/home/appuser/.local/bin/uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8001"]
      env:
        - name: DB_USER
          value: "postgres"
        - name: DB_PASSWORD
          value: "password"
        - name: DB_HOST
          value: "localhost"  # Changed from 'db' to 'localhost' for single pod
        - name: DB_NAME
          value: "tasksdb"
        - name: JWT_SECRET_KEY
          value: "un_secret_tres_fort_a_changer"
      ports:
        - containerPort: 8001
          name: tasks-api

    # Frontend (Nginx with reverse proxy)
    - name: frontend
      image: frontend:latest
      imagePullPolicy: Never
      env:
        - name: AUTH_API_URL
          value: "http://localhost:8000/"  # Added trailing slash for proper proxy_pass
        - name: TASKS_API_URL
          value: "http://localhost:8001/"  # Added trailing slash for proper proxy_pass
        - name: PORT
          value: "80"
      ports:
        - containerPort: 80
          hostPort: 8080  # Expose on host port 8080

  volumes:
    - name: postgres-storage
      persistentVolumeClaim:
        claimName: postgres-pvc
